<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Organizer Panel ‚Äî TourneyHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <script defer src="script.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="header-bar">
      <a class="logo" href="index.html">TourneyHub</a>
     
      </button>
    </div>
<!-- Bottom navigation (place as last element inside <body>) -->

  </header>

  <!-- Bottom navigation (place as last element inside <body>) -->
<nav class="bottom-nav" aria-label="Mobile navigation">
  <a href="tournaments.html" aria-label="Tournaments" data-route="tournaments">üèÜ</a>
  <a href="profile.html" aria-label="My Dashboard" data-route="profile">üë§</a>
  <a href="wallet.html" aria-label="Wallet" data-route="wallet">üí∞</a>
  <a href="admin.html" aria-label="Organizer Panel" data-route="admin">‚öôÔ∏è</a>
  <a href="login.html" aria-label="Sign in / Join" data-route="login">üîë</a>
</nav>


  <main class="container">
    <div class="section card">
      <div class="section-header">
        <h2>Organizer Actions</h2>
      </div>
      <div class="tab-bar" style="display:flex;gap:12px;margin-bottom:24px;">
        <button class="tab active" id="tab-create">New Tournament</button>
        <button class="tab" id="tab-payments">Verify Payments</button>
        <button class="tab" id="tab-hosted">Hosted Tournaments</button>
      </div>
      <div id="admin-content"></div>
    </div>
  </main>

  <script>
    // Tab switching logic
    const tabCreate = document.getElementById('tab-create');
    const tabPayments = document.getElementById('tab-payments');
    const tabHosted = document.getElementById('tab-hosted');
    const adminContent = document.getElementById('admin-content');
    const tabs = [tabCreate, tabPayments, tabHosted];

    function setActive(tab) {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
    }

    tabCreate.onclick = () => {
      setActive(tabCreate);
      renderCreateTournament();
    };
    tabPayments.onclick = () => {
      setActive(tabPayments);
      renderPayments();
    };
    tabHosted.onclick = () => {
      setActive(tabHosted);
      renderHostedTournaments();
    };

    // Initial tab
    renderCreateTournament();

    // --- Create Tournament ---
    function renderCreateTournament() {
      adminContent.innerHTML = `
        <h2>üöÄ Launch a New Tournament</h2>
        <label class="input"><span>Title</span><input id="t-title" placeholder="Tournament name" /></label>
        <label class="input"><span>Description</span><textarea id="t-desc" rows="3" placeholder="Rules, format, prizes"></textarea></label>
        <label class="input"><span>Game</span><input id="t-game" placeholder="e.g., Valorant" /></label>
        <label class="input"><span>Type</span>
          <select id="t-type">
            <option value="SOLO">Solo</option>
            <option value="TEAM">Team</option>
          </select>
        </label>
        <label class="input"><span>Bracket</span>
          <select id="t-bracket">
            <option value="SINGLE_ELIM">Single Elimination</option>
            <option value="DOUBLE_ELIM">Double Elimination</option>
          </select>
        </label>
        <label class="input"><span>Max Participants</span><input id="t-max" type="number" value="16" /></label>
        <label class="input"><span>Entry Fee (‚Çπ)</span><input id="t-fee" type="number" value="0" /></label>
        <label class="input"><span>Start Date</span><input id="t-start" type="datetime-local" /></label>
        <button id="create-btn" class="btn btn-primary">Create Tournament</button>
      `;
      // Attach create logic if using inline JS, otherwise handled in script.js
      if (window.initAdminCreate) window.initAdminCreate();
    }

    // --- Payments Verification ---
    function renderPayments() {
      // Get payments from localStorage
      const payments = JSON.parse(localStorage.getItem("walletPayments") || "[]");
      if (!payments.length) {
        adminContent.innerHTML = `<p class="muted">No wallet transactions yet.</p>`;
        return;
      }
      adminContent.innerHTML = `
        <h2>üí≥ Wallet Payments ‚Äî Verify UTR</h2>
        <div>
          <div style="margin-bottom:12px;">
            <span class="tiny" style="color:#ffa726;">Pending</span> | 
            <span class="tiny" style="color:#4caf50;">Verified</span> | 
            <span class="tiny" style="color:#e53935;">Cancelled</span>
          </div>
          <div id="wallet-verification-list">
            ${payments.map(p => `
              <div class="item flex-between" style="margin-bottom:16px;">
                <div>
                  <strong>User:</strong> ${p.userId}<br>
                  <strong>UTR:</strong> ${p.utr}<br>
                  <strong>Amount:</strong> ‚Çπ${p.amount || "-"}<br>
                  <span class="tiny muted">${p.createdAt}</span>
                  ${p.status === "CANCELLED" && p.remark ? `<div class="tiny" style="color:#e53935;"><strong>Remark:</strong> ${p.remark}</div>` : ""}
                </div>
                <div>
                  ${p.status === "PENDING" ? `
                    <button class="btn btn-outline tiny" onclick="verifyWalletPayment('${p.id}')">Verify</button>
                    <button class="btn btn-outline tiny" onclick="cancelWalletPayment('${p.id}')">Cancel</button>
                  ` : ""}
                  <span class="tiny" style="color:${p.status === "VERIFIED" ? "#4caf50" : p.status === "CANCELLED" ? "#e53935" : "#ffa726"}">${p.status}</span>
                </div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
    }

    // --- Hosted Tournaments ---
    function renderHostedTournaments() {
      // Get tournaments from localStorage
      const tournaments = JSON.parse(localStorage.getItem("tournaments") || "[]");
      adminContent.innerHTML = `
        <h2>üìä Your Hosted Tournaments</h2>
        <div id="admin-list">
          ${tournaments.length ? tournaments.map(t => `
            <div class="item flex-between" style="margin-bottom:16px;">
              <div>
                <strong>${t.title}</strong>
                <div class="tiny muted">${t.game} ‚Ä¢ ${t.type} ‚Ä¢ ${t.bracket}</div>
                <div class="tiny muted">Participants: ${t.participants ? t.participants.length : 0}/${t.max}</div>
              </div>
              <div style="display:flex;gap:8px;">
                <button class="btn btn-outline tiny bracket-btn" data-id="${t.id}">View Bracket</button>
                <button class="btn btn-outline tiny schedule-btn" data-id="${t.id}">View Schedule</button>
                <button class="btn btn-outline tiny" onclick="generateBracket('${t.id}')">Generate Bracket</button>
                <button class="btn btn-outline tiny delete-btn" data-id="${t.id}">Delete</button>
              </div>
            </div>
          `).join("") : `<p class="muted">No tournaments hosted yet.</p>`}
        </div>
        <div id="admin-bracket-modal"></div>
      `;
      // Clear modal when switching tab
      const modal = document.getElementById("admin-bracket-modal");
      if (modal) modal.innerHTML = "";

      // Attach event listeners after DOM update
      setTimeout(function() {
        document.querySelectorAll('.bracket-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            window.showBracket(btn.getAttribute('data-id'));
          });
        });
        document.querySelectorAll('.schedule-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            window.showSchedule(btn.getAttribute('data-id'));
          });
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            window.deleteTournament(btn.getAttribute('data-id'));
          });
        });
      }, 0);
    }

    // --- Withdrawal Requests (Admin Panel) ---
    function renderWithdrawals() {
      const withdrawals = JSON.parse(localStorage.getItem("withdrawalRequests") || "[]");
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      adminContent.innerHTML = `
        <h2>üí∏ Withdrawal Requests</h2>
        <div id="withdrawal-list">
          ${withdrawals.length ? withdrawals.map(req => {
            const user = users.find(u => u.id === req.userId);
            return `
              <div class="item card" style="margin-bottom:16px;">
                <div>
                  <strong>User:</strong> ${user ? (user.name || user.email) : req.userId}<br>
                  <strong>Amount:</strong> ‚Çπ${req.amount}<br>
                  <strong>UPI Name:</strong> ${req.upiInfo.name}<br>
                  <strong>UPI ID:</strong> ${req.upiInfo.upiId}<br>
                  <span class="tiny muted">${req.createdAt}</span>
                  ${req.remark ? `<div class="tiny" style="color:#e53935;"><strong>Remark:</strong> ${req.remark}</div>` : ""}
                </div>
                <div style="margin-top:8px;">
                  ${req.status === "PENDING" ? `
                    <button class="btn btn-outline tiny" onclick="processWithdrawalRequest('${req.id}', 'PAID')">Send Payment</button>
                    <button class="btn btn-outline tiny" onclick="rejectWithdrawal('${req.id}')">Reject</button>
                  ` : `<span class="tiny" style="color:${req.status === "PAID" ? "#4caf50" : "#e53935"}">${req.status}</span>`}
                </div>
              </div>
            `;
          }).join("") : `<p class="muted">No withdrawal requests yet.</p>`}
        </div>
      `;
    }

    // Add tab for withdrawals
    const tabWithdrawals = document.createElement('button');
    tabWithdrawals.className = 'tab';
    tabWithdrawals.id = 'tab-withdrawals';
    tabWithdrawals.textContent = 'Withdrawal Sender';
    document.querySelector('.tab-bar').appendChild(tabWithdrawals);
    tabs.push(tabWithdrawals);

    tabWithdrawals.onclick = () => {
      setActive(tabWithdrawals);
      renderWithdrawals();
    };

    // Admin: send payment or reject withdrawal
    window.processWithdrawalRequest = function(requestId, status) {
      const withdrawals = JSON.parse(localStorage.getItem("withdrawalRequests") || "[]");
      const req = withdrawals.find(r => r.id === requestId);
      if (!req) return alert("Withdrawal request not found.");
      req.status = status;
      req.remark = "";
      localStorage.setItem("withdrawalRequests", JSON.stringify(withdrawals));
      // Notify user (add to gifts for notification)
      if (status === "PAID") {
        const gifts = JSON.parse(localStorage.getItem("gifts") || "[]");
        gifts.push({
          id: Math.random().toString(36).slice(2, 10),
          userId: req.userId,
          tournamentId: null,
          message: `Your withdrawal of ‚Çπ${req.amount} to UPI ID ${req.upiInfo.upiId} has been processed.`,
          createdAt: new Date().toISOString()
        });
        localStorage.setItem("gifts", JSON.stringify(gifts));
      }
      alert("Withdrawal processed!");
      renderWithdrawals();
    };

    window.rejectWithdrawal = function(requestId) {
      const withdrawals = JSON.parse(localStorage.getItem("withdrawalRequests") || "[]");
      const req = withdrawals.find(r => r.id === requestId);
      if (!req) return alert("Withdrawal request not found.");
      const remark = prompt("Enter reason for rejection:", "");
      req.status = "REJECTED";
      req.remark = remark || "";
      localStorage.setItem("withdrawalRequests", JSON.stringify(withdrawals));
      // Notify user
      const gifts = JSON.parse(localStorage.getItem("gifts") || "[]");
      gifts.push({
        id: Math.random().toString(36).slice(2, 10),
        userId: req.userId,
        tournamentId: null,
        message: `Your withdrawal request was rejected. ${remark}`,
        createdAt: new Date().toISOString()
      });
      localStorage.setItem("gifts", JSON.stringify(gifts));
      alert("Withdrawal rejected!");
      renderWithdrawals();
    };

    // Add this function to allow tournament deletion from admin panel
    window.deleteTournament = function(tid) {
      if (!confirm("Are you sure you want to delete this tournament?")) return;
      let tournaments = JSON.parse(localStorage.getItem("tournaments") || "[]");
      tournaments = tournaments.filter(t => t.id !== tid);
      localStorage.setItem("tournaments", JSON.stringify(tournaments));
      alert("Tournament deleted!");
      renderHostedTournaments();
    };

    // Add this function to allow bracket generation from admin panel
    window.generateBracket = function(tid) {
      const tournaments = JSON.parse(localStorage.getItem("tournaments") || "[]");
      const t = tournaments.find(x => x.id === tid);
      if (!t) return alert("Tournament not found.");
      if (!t.participants || t.participants.length < 2) return alert("Need at least 2 participants to generate bracket.");
      // Shuffle participants
      const p = [...t.participants];
      p.sort(() => Math.random() - 0.5);
      const matches = [];
      for (let i = 0; i < p.length; i += 2) {
        const a = p[i], b = p[i + 1];
        if (!b) continue;
        matches.push({ id: Math.random().toString(36).slice(2, 8), round: 1, a, b, scoreA: 0, scoreB: 0, winner: null });
      }
      t.matches = matches;
      localStorage.setItem("tournaments", JSON.stringify(tournaments));
      alert("Bracket generated!");
      renderHostedTournaments();
    };

    window.showBracket = function(tid) {
      const tournaments = JSON.parse(localStorage.getItem("tournaments") || "[]");
      const t = tournaments.find(x => x.id === tid);
      const modal = document.getElementById("admin-bracket-modal");
      if (!t || !modal) return;
      if (!t.matches || !t.matches.length) {
        modal.innerHTML = `<div class="card" style="margin-top:16px;"><h3>Bracket</h3><p class="muted">Bracket will appear once seeded.</p></div>`;
        return;
      }
      // Render bracket rounds with score edit buttons
      const rounds = {};
      t.matches.forEach(m => { (rounds[m.round] ||= []).push(m); });
      modal.innerHTML = `
        <div class="card" style="margin-top:16px;">
          <h3>Bracket ‚Äî ${t.title}</h3>
          <div class="bracket">
            ${Object.keys(rounds).sort((a,b)=>a-b).map(r=>`
              <div class="round">
                <h4>Round ${r}</h4>
                ${rounds[r].map(m=>`
                  <div class="match">
                    <div class="row">
                      <span>${getUserName(m.a)}</span>
                      <span class="score">${m.scoreA}</span>
                    </div>
                    <div class="row">
                      <span>${getUserName(m.b)}</span>
                      <span class="score">${m.scoreB}</span>
                    </div>
                    <div class="row tiny muted">
                      <span>Round ${m.round}</span>
                      <button class="btn btn-outline tiny" onclick="editMatchScore('${tid}','${m.id}')">Edit Score</button>
                    </div>
                  </div>
                `).join("")}
              </div>
            `).join("")}
          </div>
        </div>
      `;
    };

    // Score editing logic for admin
    window.editMatchScore = function(tid, matchId) {
      const tournaments = JSON.parse(localStorage.getItem("tournaments") || "[]");
      const t = tournaments.find(x => x.id === tid);
      if (!t) return alert("Tournament not found.");
      const m = t.matches.find(x => x.id === matchId);
      if (!m) return alert("Match not found.");
      const scoreA = parseInt(prompt(`Enter score for ${getUserName(m.a)}`, m.scoreA), 10);
      const scoreB = parseInt(prompt(`Enter score for ${getUserName(m.b)}`, m.scoreB), 10);
      if (isNaN(scoreA) || isNaN(scoreB)) return alert("Invalid score.");
      m.scoreA = scoreA;
      m.scoreB = scoreB;
      m.winner = scoreA === scoreB ? null : scoreA > scoreB ? m.a : m.b;
      localStorage.setItem("tournaments", JSON.stringify(tournaments));
      alert("Score updated!");
      window.showBracket(tid);
    };

    function getUserName(uid) {
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const u = users.find(x => x.id === uid);
      return u ? (u.name || u.email) : "Unknown";
    }

    // --- Payment Actions ---
    window.verifyWalletPayment = function(paymentId) {
      const payments = JSON.parse(localStorage.getItem("walletPayments") || "[]");
      const payment = payments.find(p => p.id === paymentId);
      if (!payment) return alert("Payment not found.");
      payment.status = "VERIFIED";
      localStorage.setItem("walletPayments", JSON.stringify(payments));
      alert("Payment verified!");
      renderPayments();
    };

    window.cancelWalletPayment = function(paymentId) {
      const payments = JSON.parse(localStorage.getItem("walletPayments") || "[]");
      const payment = payments.find(p => p.id === paymentId);
      if (!payment) return alert("Payment not found.");
      const remark = prompt("Enter remark for cancellation (visible to user):", "");
      payment.status = "CANCELLED";
      payment.remark = remark || "";
      localStorage.setItem("walletPayments", JSON.stringify(payments));
      alert("Payment cancelled!");
      renderPayments();
    };

    // --- Tournament Create Logic (if not handled in script.js) ---
    window.initAdminCreate = function() {
      const btn = document.getElementById("create-btn");
      if (!btn) return;
      btn.onclick = () => {
        const title = document.getElementById("t-title").value;
        const desc = document.getElementById("t-desc").value;
        const game = document.getElementById("t-game").value;
        const type = document.getElementById("t-type").value;
        const bracket = document.getElementById("t-bracket").value;
        const max = parseInt(document.getElementById("t-max").value, 10) || 16;
        const fee = parseInt(document.getElementById("t-fee").value, 10) || 0;
        const start = document.getElementById("t-start").value;
        if (!title) return alert("Title required");
        const tournaments = JSON.parse(localStorage.getItem("tournaments") || "[]");
        tournaments.unshift({
          id: Math.random().toString(36).slice(2, 10),
          title,
          description: desc,
          game: game || "General",
          type,
          bracket,
          max,
          fee,
          startsAt: start ? new Date(start).toISOString() : new Date().toISOString(),
          published: true,
          participants: [],
          matches: []
        });
        localStorage.setItem("tournaments", JSON.stringify(tournaments));
        alert("Tournament created");
        renderCreateTournament();
      };
    };
  </script>
</body>
</html>