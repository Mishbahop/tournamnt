<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <title>Admin ‚Äî TourneyHub (Mobile)</title>
  <body>
      <nav class="bottom-nav" aria-label="Mobile navigation">
    <a href="tournaments.html" aria-label="Tournaments">üèÜ</a>
    <a href="wallet.html" aria-label="Wallet">üí∞</a>
    <a href="admin.html" aria-label="Organizer Panel">‚öôÔ∏è</a>
    <a href="login.html" aria-label="Sign in / Join">üîë</a>
       <a href="dashboard.html" aria-label="My Dashboard">üë§</a>
  </nav>
  </body>
  <style>
    :root{
      --bg:#070812; --panel:#0f1724; --muted:#9aa6b2; --accent:#2563eb;
      --ok:#16a34a; --bad:#ef4444; --card:#0b1220; --line:#1f2a38; --glass: rgba(255,255,255,0.03);
      --radius:12px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e6eef8;background:var(--bg);}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);backdrop-filter: blur(6px);border-bottom:1px solid var(--line);padding:12px 14px;display:flex;align-items:center;gap:12px;z-index:40;}
    .logo{font-weight:700;color:var(--accent);font-size:16px;text-decoration:none}
    .badge{margin-left:auto;padding:6px 10px;border-radius:999px;background:var(--card);font-size:13px;border:1px solid var(--line);color:var(--muted)}
    main{padding:14px;max-width:980px;margin:0 auto;}
    .card{background:linear-gradient(180deg,var(--panel),var(--card));border-radius:var(--radius);padding:12px;border:1px solid var(--line);box-shadow:0 6px 18px rgba(2,6,23,0.6);margin-bottom:12px;}
    h1{font-size:18px;margin:0 0 8px 0}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;margin-top:10px}
    button{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;background:var(--accent);color:white;box-shadow:0 6px 12px rgba(2,6,23,0.45)}
    button.ghost{background:transparent;border:1px solid var(--line);color:var(--muted);box-shadow:none}
    button.small{padding:8px 10px;font-size:14px;border-radius:9px}
    .stats{display:flex;gap:8px;overflow:auto;padding-bottom:4px;margin-top:8px}
    .stat{min-width:120px;background:var(--glass);padding:10px;border-radius:10px;border:1px solid var(--line)}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    /* table desktop, cards mobile */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{font-size:13px;color:var(--muted);background:transparent}
    .action-row{display:flex;gap:8px;flex-wrap:wrap}
    .approve{background:var(--ok);color:#05240f}
    .reject{background:var(--bad)}
    /* mobile cards */
    .list-card{display:block;background:transparent;border:1px solid var(--line);padding:12px;border-radius:10px}
    .row-title{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:6px}
    .row-meta{color:var(--muted);font-size:13px;margin-bottom:6px}
    .compact-amount{font-weight:800}
    /* search */
    .search-wrap{display:flex;gap:8px;align-items:center}
    .search{flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:transparent;color:inherit}
    /* responsive */
    @media(min-width:920px){
      .grid{grid-template-columns:1fr 1fr}
      .list-card.mobile-only{display:none}
      .table-only{display:table}
    }
    @media(max-width:919px){
      .table-only{display:none}
      .list-card.mobile-only{display:block}
    }
    /* touch improvements */
    button, .search, input{touch-action:manipulation;-webkit-tap-highlight-color:transparent}
    .center{display:flex;align-items:center;justify-content:center}
    .no-data{color:var(--muted);padding:12px;text-align:center}
    footer{padding:14px;text-align:center;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>
    <a class="logo" href="#">TourneyHub</a>
    <div style="margin-left:8px;color:var(--muted);font-size:13px">Admin</div>
    <div class="badge" id="admin-badge">Checking‚Ä¶</div>
  </header>

  <main>
    <div id="gate" class="card">
      <h1>Admin access</h1>
      <p id="status" class="muted">Verifying your permissions‚Ä¶</p>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="refresh-claims" class="small">Refresh</button>
        <button id="signout" class="ghost small" onclick="signOut()">Sign out</button>
      </div>
    </div>

    <div id="dashboard" style="display:none">
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="flex:1">
            <div style="display:flex;gap:8px;align-items:center">
              <h1 style="margin:0">Overview</h1>
            </div>
            <div class="muted" style="margin-top:6px;font-size:13px">Quick operational view</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <div style="display:flex;gap:8px">
              <button id="reload" class="small">Reload</button>
            </div>
          </div>
        </div>

        <div class="stats" aria-hidden="false">
          <div class="stat">
            <div class="muted" style="font-size:12px">Deposits pending</div>
            <div id="stat-deposits-pending" style="font-weight:800;font-size:18px">‚Äî</div>
          </div>
          <div class="stat">
            <div class="muted" style="font-size:12px">Withdrawals pending</div>
            <div id="stat-withdrawals-pending" style="font-weight:800;font-size:18px">‚Äî</div>
          </div>
          <div class="stat">
            <div class="muted" style="font-size:12px">Approved today</div>
            <div id="stat-approved-today" style="font-weight:800;font-size:18px">‚Äî</div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center" class="search-wrap">
          <input id="globalSearch" class="search" placeholder="Search by email or amount" aria-label="Search transactions" />
          <button id="clearSearch" class="ghost small">Clear</button>
        </div>
      </div>

      <div class="grid">
        <!-- Deposits card / table -->
        <section class="card" aria-labelledby="deposits-title">
          <h2 id="deposits-title" style="font-size:16px;margin-bottom:8px">Deposits</h2>

          <!-- mobile list -->
          <div id="deposits-list-mobile"></div>

          <!-- desktop table -->
          <div class="table-only" style="overflow:auto">
            <table id="table-deposits" role="table" aria-label="Deposits table">
              <thead>
                <tr><th>Email</th><th>Amount</th><th>Status</th><th>Created</th><th>Action</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

        </section>

        <!-- Withdrawals -->
        <section class="card" aria-labelledby="withdrawals-title">
          <h2 id="withdrawals-title" style="font-size:16px;margin-bottom:8px">Withdrawals</h2>

          <div id="withdrawals-list-mobile"></div>

          <div class="table-only" style="overflow:auto">
            <table id="table-withdrawals" role="table" aria-label="Withdrawals table">
              <thead>
                <tr><th>Email</th><th>Amount</th><th>Status</th><th>Created</th><th>Action</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <div class="card">
        <h2 style="font-size:16px">User balances</h2>
        <div class="muted" style="margin-bottom:8px">Approved deposits minus approved withdrawals</div>

        <div id="balances-list-mobile"></div>

        <div class="table-only" style="overflow:auto">
          <table id="table-balances"><thead><tr><th>Email</th><th>Deposits</th><th>Withdrawals</th><th>Balance</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <footer>Tap actions to approve or reject. Use search to filter results.</footer>
  </main>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

  <script>
    // CONFIG: replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "AIzaSyA7QsyV2yb4f_acY9ETQnTSna7YHxwOJw4",
      authDomain: "authapp-386ee.firebaseapp.com",
      projectId: "authapp-386ee",
      storageBucket: "authapp-386ee.firebasestorage.app",
      messagingSenderId: "809698525310",
      appId: "1:809698525310:web:5cb7de80bde9ed1f26982f",
      measurementId: "G-EJZTSBSGQT"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // UI refs
    const adminBadge = document.getElementById('admin-badge');
    const statusBox = document.getElementById('status');
    const gate = document.getElementById('gate');
    const dashboard = document.getElementById('dashboard');

    const depositsTableBody = document.querySelector('#table-deposits tbody');
    const withdrawalsTableBody = document.querySelector('#table-withdrawals tbody');
    const depositsListMobile = document.getElementById('deposits-list-mobile');
    const withdrawalsListMobile = document.getElementById('withdrawals-list-mobile');

    const balancesTableBody = document.querySelector('#table-balances tbody');
    const balancesListMobile = document.getElementById('balances-list-mobile');

    const statDepositsPending = document.getElementById('stat-deposits-pending');
    const statWithdrawalsPending = document.getElementById('stat-withdrawals-pending');
    const statApprovedToday = document.getElementById('stat-approved-today');

    const reloadBtn = document.getElementById('reload');
    const refreshClaims = document.getElementById('refresh-claims');
    const signoutBtn = document.getElementById('signout');
    const globalSearch = document.getElementById('globalSearch');
    const clearSearch = document.getElementById('clearSearch');

    // search state
    let searchQuery = '';

    // sign out helper
    function signOut() {
      auth.signOut().then(() => location.href = 'login.html').catch(console.error);
    }

    refreshClaims.addEventListener('click', async () => {
      const u = auth.currentUser;
      if (!u) return;
      try {
        await u.getIdTokenResult(true);
        verifyAdminByRole(u);
      } catch (e) { console.error(e); }
    });

    reloadBtn.addEventListener('click', loadAll);
    clearSearch.addEventListener('click', () => { globalSearch.value=''; searchQuery=''; loadAll(); });

    globalSearch.addEventListener('input', (e) => {
      searchQuery = (e.target.value || '').trim().toLowerCase();
      // small debounce
      if (window._srchTm) clearTimeout(window._srchTm);
      window._srchTm = setTimeout(loadAll, 250);
    });

    // auth gate
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        statusBox.textContent = 'Not signed in. Redirecting‚Ä¶';
        setTimeout(()=>location.href='login.html',700);
        return;
      }
      await verifyAdminByRole(user);
    });

    async function verifyAdminByRole(user) {
      try {
        statusBox.textContent = 'Checking admin role‚Ä¶';
        // try token claim first
        let claimAdmin = false;
        try {
          const t = await user.getIdTokenResult(true);
          claimAdmin = t?.claims?.admin === true;
          console.log('token claims', t.claims);
        } catch (e) { console.warn('claim read failed', e); }

        // read users/{uid}
        let roleAdmin = false;
        try {
          const doc = await db.collection('users').doc(user.uid).get();
          if (doc.exists) roleAdmin = doc.data()?.role === 'admin';
          else console.warn('users doc not found:', user.uid);
        } catch (err) {
          console.error('Error reading users doc', err);
          statusBox.innerHTML = `Error reading users document: ${err?.code || ''} ${err?.message || ''}`;
          adminBadge.textContent = 'Admin: error';
          adminBadge.style.color = '#f59e0b';
          return;
        }

        const isAdmin = claimAdmin || roleAdmin;
        adminBadge.textContent = isAdmin ? 'Admin: active' : 'Admin: denied';
        adminBadge.style.color = isAdmin ? '#10b981' : '#ef4444';

        if (!isAdmin) {
          statusBox.innerHTML = '‚õî Access denied. Not an admin.<br><span class="muted">Ensure users/{uid}.role is "admin".</span>';
          dashboard.style.display = 'none';
          return;
        }
        statusBox.textContent = '‚úÖ Admin access granted';
        gate.style.display = 'none';
        dashboard.style.display = 'block';
        await loadAll();
      } catch (e) {
        console.error('verify error', e);
        statusBox.textContent = 'Error verifying admin access: ' + (e?.message || e);
      }
    }

    // load all: deposits & withdrawals & balances
    async function loadAll() {
      await Promise.all([loadDeposits(), loadWithdrawals()]);
      await Promise.all([computeBalances(), computeStats()]);
    }

    function filterMatch(text){
      if(!searchQuery) return true;
      return (String(text||'').toLowerCase().indexOf(searchQuery) !== -1);
    }

    // deposits
    async function loadDeposits(){
      depositsTableBody.innerHTML = `<tr><td colspan="5" class="no-data">Loading‚Ä¶</td></tr>`;
      depositsListMobile.innerHTML = '';
      try {
        const snap = await db.collection('deposits').orderBy('createdAt','desc').get();
        const items = [];
        snap.forEach(doc => {
          const d = doc.data();
          items.push({ id: doc.id, data: d });
        });
        // apply client filter
        const filtered = items.filter(it => filterMatch(it.data.email) || filterMatch(it.data.amount));

        // render mobile list
        if(filtered.length===0) depositsListMobile.innerHTML = `<div class="no-data">No deposits</div>`;
        else depositsListMobile.innerHTML = filtered.map(it => {
          const d = it.data;
          const created = d.createdAt?.toDate?.().toLocaleString() || (d.createdAtClient || '‚Äî');
          return `
            <article class="list-card mobile-only" role="article">
              <div class="row-title">
                <div style="flex:1">
                  <div style="font-weight:800">${d.email || '‚Äî'}</div>
                  <div class="row-meta">${created}</div>
                </div>
                <div style="text-align:right">
                  <div class="compact-amount">‚Çπ${Number(d.amount||0).toLocaleString()}</div>
                  <div class="row-meta">${d.status||'pending'}</div>
                </div>
              </div>
              <div style="display:flex;gap:8px;justify-content:flex-end">
                <button class="approve small" data-id="${it.id}" data-col="deposits" data-action="approved">Approve</button>
                <button class="reject small" data-id="${it.id}" data-col="deposits" data-action="rejected">Reject</button>
              </div>
            </article>`;
        }).join('');

        // render desktop table
        if(filtered.length===0) depositsTableBody.innerHTML = `<tr><td colspan="5" class="no-data">No deposits</td></tr>`;
        else depositsTableBody.innerHTML = filtered.map(it => {
          const d = it.data;
          const created = d.createdAt?.toDate?.().toLocaleString() || (d.createdAtClient || '‚Äî');
          return `<tr>
            <td>${d.email||'‚Äî'}</td>
            <td>‚Çπ${Number(d.amount||0).toLocaleString()}</td>
            <td>${d.status||'pending'}</td>
            <td>${created}</td>
            <td class="action-row">
              <button class="approve small" data-id="${it.id}" data-col="deposits" data-action="approved">Approve</button>
              <button class="reject small" data-id="${it.id}" data-col="deposits" data-action="rejected">Reject</button>
            </td>
          </tr>`;
        }).join('');

        attachActionHandlers();
      } catch (err) {
        console.error('Load deposits error', err);
        depositsTableBody.innerHTML = `<tr><td colspan="5" class="no-data">Error loading deposits</td></tr>`;
        depositsListMobile.innerHTML = `<div class="no-data">Error loading deposits</div>`;
      }
    }

    async function loadWithdrawals(){
      withdrawalsTableBody.innerHTML = `<tr><td colspan="5" class="no-data">Loading‚Ä¶</td></tr>`;
      withdrawalsListMobile.innerHTML = '';
      try {
        const snap = await db.collection('withdrawals').orderBy('createdAt','desc').get();
        const items = [];
        snap.forEach(doc => { items.push({ id: doc.id, data: doc.data() }); });

        const filtered = items.filter(it => filterMatch(it.data.email) || filterMatch(it.data.amount));

        if(filtered.length===0) withdrawalsListMobile.innerHTML = `<div class="no-data">No withdrawals</div>`;
        else withdrawalsListMobile.innerHTML = filtered.map(it => {
          const w = it.data;
          const created = w.createdAt?.toDate?.().toLocaleString() || (w.createdAtClient || '‚Äî');
          return `
            <article class="list-card mobile-only" role="article">
              <div class="row-title">
                <div style="flex:1">
                  <div style="font-weight:800">${w.email || '‚Äî'}</div>
                  <div class="row-meta">${created}</div>
                </div>
                <div style="text-align:right">
                  <div class="compact-amount">‚Çπ${Number(w.amount||0).toLocaleString()}</div>
                  <div class="row-meta">${w.status||'pending'}</div>
                </div>
              </div>
              <div style="display:flex;gap:8px;justify-content:flex-end">
                <button class="approve small" data-id="${it.id}" data-col="withdrawals" data-action="approved">Approve</button>
                <button class="reject small" data-id="${it.id}" data-col="withdrawals" data-action="rejected">Reject</button>
              </div>
            </article>`;
        }).join('');

        if(filtered.length===0) withdrawalsTableBody.innerHTML = `<tr><td colspan="5" class="no-data">No withdrawals</td></tr>`;
        else withdrawalsTableBody.innerHTML = filtered.map(it => {
          const w = it.data;
          const created = w.createdAt?.toDate?.().toLocaleString() || (w.createdAtClient || '‚Äî');
          return `<tr>
            <td>${w.email||'‚Äî'}</td>
            <td>‚Çπ${Number(w.amount||0).toLocaleString()}</td>
            <td>${w.status||'pending'}</td>
            <td>${created}</td>
            <td class="action-row">
              <button class="approve small" data-id="${it.id}" data-col="withdrawals" data-action="approved">Approve</button>
              <button class="reject small" data-id="${it.id}" data-col="withdrawals" data-action="rejected">Reject</button>
            </td>
          </tr>`;
        }).join('');

        attachActionHandlers();
      } catch (err) {
        console.error('Load withdrawals error', err);
        withdrawalsTableBody.innerHTML = `<tr><td colspan="5" class="no-data">Error loading withdrawals</td></tr>`;
        withdrawalsListMobile.innerHTML = `<div class="no-data">Error loading withdrawals</div>`;
      }
    }

    function attachActionHandlers(){
      document.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = async (e)=>{
          const id = btn.getAttribute('data-id');
          const col = btn.getAttribute('data-col');
          const action = btn.getAttribute('data-action');
          btn.disabled = true;
          try{
            await db.collection(col).doc(id).update({ status: action, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            await loadAll();
          }catch(err){
            console.error('action error', err); alert('Error updating: '+(err?.message||err));
          } finally { btn.disabled = false; }
        };
      });
    }

    // compute balances
    async function computeBalances(){
      balancesTableBody.innerHTML = `<tr><td colspan="4" class="no-data">Loading‚Ä¶</td></tr>`;
      balancesListMobile.innerHTML = '';
      try{
        const [depSnap, witSnap] = await Promise.all([
          db.collection('deposits').where('status','==','approved').get(),
          db.collection('withdrawals').where('status','==','approved').get()
        ]);
        const totals = new Map();
        depSnap.forEach(doc=>{
          const d = doc.data();
          const e = d.email || '‚Äî';
          const amt = Number(d.amount||0);
          const cur = totals.get(e) || {dep:0,wit:0}; cur.dep += amt; totals.set(e,cur);
        });
        witSnap.forEach(doc=>{
          const w = doc.data();
          const e = w.email || '‚Äî';
          const amt = Number(w.amount||0);
          const cur = totals.get(e) || {dep:0,wit:0}; cur.wit += amt; totals.set(e,cur);
        });

        const rows = Array.from(totals.entries()).map(([email,t])=>{
          const bal = t.dep - t.wit;
          return { email, dep: t.dep, wit: t.wit, bal };
        }).sort((a,b)=>b.bal - a.bal);

        if(rows.length===0){
          balancesTableBody.innerHTML = `<tr><td colspan="4" class="no-data">No approved transactions</td></tr>`;
          balancesListMobile.innerHTML = `<div class="no-data">No approved balances</div>`;
        } else {
          balancesTableBody.innerHTML = rows.map(r=>`
            <tr>
              <td>${r.email}</td>
              <td>‚Çπ${r.dep.toLocaleString()}</td>
              <td>‚Çπ${r.wit.toLocaleString()}</td>
              <td>‚Çπ${r.bal.toLocaleString()}</td>
            </tr>`).join('');

          balancesListMobile.innerHTML = rows.map(r=>`
            <article class="list-card mobile-only">
              <div class="row-title"><div style="font-weight:800">${r.email}</div><div style="text-align:right;font-weight:800">‚Çπ${r.bal.toLocaleString()}</div></div>
              <div class="row-meta">Deposits ‚Çπ${r.dep.toLocaleString()} ‚Ä¢ Withdrawals ‚Çπ${r.wit.toLocaleString()}</div>
            </article>`).join('');
        }
      }catch(err){
        console.error('compute balances error', err);
        balancesTableBody.innerHTML = `<tr><td colspan="4" class="no-data">Error computing balances</td></tr>`;
        balancesListMobile.innerHTML = `<div class="no-data">Error computing balances</div>`;
      }
    }

    // stats
    async function computeStats(){
      try{
        const [depPending, witPending] = await Promise.all([
          db.collection('deposits').where('status','==','pending').get(),
          db.collection('withdrawals').where('status','==','pending').get()
        ]);
        statDepositsPending.textContent = depPending.size;
        statWithdrawalsPending.textContent = witPending.size;

        const [depApproved, witApproved] = await Promise.all([
          db.collection('deposits').where('status','==','approved').get(),
          db.collection('withdrawals').where('status','==','approved').get()
        ]);
        // approximate "approved today"
        const today = new Date(); const yyyy = today.getFullYear(), mm = today.getMonth(), dd = today.getDate();
        const start = new Date(yyyy,mm,dd,0,0,0), end = new Date(yyyy,mm,dd,23,59,59);
        const inRange = (ts, clientStr) => {
          if(ts?.toDate) { const d = ts.toDate(); return d>=start && d<=end; }
          if(clientStr) { const d = new Date(clientStr); return d>=start && d<=end; }
          return false;
        };
        let ct = 0;
        depApproved.forEach(doc=>{ const d = doc.data(); if(inRange(d.updatedAt, d.createdAtClient)) ct++; });
        witApproved.forEach(doc=>{ const w = doc.data(); if(inRange(w.updatedAt, w.createdAtClient)) ct++; });
        statApprovedToday.textContent = ct;
      }catch(err){
        console.error('compute stats error', err);
        statApprovedToday.textContent = '‚Äî';
      }
    }

    // main loads
    async function loadAll(){
      // small visual hint
      statDepositsPending.textContent = '‚Ä¶';
      statWithdrawalsPending.textContent = '‚Ä¶';
      statApprovedToday.textContent = '‚Ä¶';
      await Promise.all([loadDeposits(), loadWithdrawals()]);
      await Promise.all([computeBalances(), computeStats()]);
    }

    // initial attach (buttons events delegated)
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(!t) return;
      const id = t.getAttribute && t.getAttribute('data-id');
      if(id){
        // handled in attachActionHandlers (which sets onclick), but ensure fallback here
        const col = t.getAttribute('data-col');
        const action = t.getAttribute('data-action');
        if(col && action){
          t.disabled = true;
          db.collection(col).doc(id).update({ status: action, updatedAt: firebase.firestore.FieldValue.serverTimestamp() })
            .then(()=>loadAll())
            .catch(err=>{ console.error(err); alert('Error: '+(err?.message||err)); })
            .finally(()=> t.disabled=false);
        }
      }
    });

    // expose a quick diagnostic function to console if needed
    window.adminDiag = async ()=> {
      console.log('projectId', firebase.app().options.projectId);
      console.log('user', auth.currentUser && { uid: auth.currentUser.uid, email: auth.currentUser.email });
      try{ const v = await auth.currentUser.getIdTokenResult(true); console.log('claims', v.claims); }catch(e){console.warn('token error',e);}
      try{ const udoc = await db.collection('users').doc(auth.currentUser.uid).get(); console.log('users doc', udoc.exists, udoc.data()); }catch(e){console.warn('users doc read failed', e);}
    };

  </script>
</body>
</html>
