<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register for Tournament - TourneyHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6C63FF; --primary-dark: #5A52D5; --secondary: #FF6584;
            --success: #4CD964; --error: #FF5252; --dark: #0F0F1B;
            --darker: #090914; --dark-card: #1A1A2E; --light: #FFFFFF;
            --gray: #8B8B9E;
            --gradient-primary: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--darker); color: var(--light); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }

        .container {
            width: 100%; max-width: 600px; background: var(--dark-card);
            border-radius: 20px; padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2rem; font-weight: 800; color: var(--primary); }
        .header p { color: var(--gray); margin-top: 5px; }
        .detail-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed rgba(255, 255, 255, 0.1); font-size: 1.1rem; }
        .detail-item:last-child { border-bottom: none; }
        .detail-label { color: var(--gray); }
        .detail-value { font-weight: 600; }
        .balance-info { padding: 15px; margin-top: 20px; border-radius: 10px; text-align: center; border: 2px solid var(--primary); background: rgba(108, 99, 255, 0.1); }
        .status-message { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: 500; text-align: center; opacity: 0; transition: opacity 0.3s; }
        .status-message.error { background: rgba(255, 82, 82, 0.2); color: var(--error); opacity: 1; }
        .status-message.success { background: rgba(76, 217, 100, 0.2); color: var(--success); opacity: 1; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 25px; background: var(--gradient-primary); color: white; box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(108, 99, 255, 0.4); }
        .btn:disabled { background: var(--gray); cursor: not-allowed; opacity: 0.7; }
        .loading-spinner { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container" id="regContainer" style="display:none;">
        <div class="header">
            <h1 id="tourneyTitle"></h1>
            <p id="tourneyGame"></p>
        </div>
        <div id="loadingDetails" style="text-align:center; padding: 40px;">
             <div class="loading-spinner" style="width: 30px; height: 30px;"></div>
             <p>Fetching Details...</p>
        </div>
        <div id="detailsContent" style="display:none;">
            <div class="detail-item"><span class="detail-label">Entry Fee</span><span class="detail-value" id="entryFeeDisplay"></span></div>
            <div class="detail-item"><span class="detail-label">Prize Pool</span><span class="detail-value" id="prizePoolDisplay"></span></div>
            <div class="detail-item"><span class="detail-label">Starts</span><span class="detail-value" id="startDateDisplay"></span></div>
            <div class="balance-info">
                <div>Your Current Balance</div>
                <div style="font-size: 1.8rem; font-weight: 800;" id="currentBalanceDisplay">...</div>
            </div>
            <button class="btn" id="registerBtn" onclick="handleRegistration()">Register and Pay Fee</button>
            <div class="status-message" id="regStatus"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // =================================================================
        // SETUP & INITIALIZATION
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA7QsyV2yb4f_acY9ETQnTSna7YHxwOJw4",
            authDomain: "authapp-386ee.firebaseapp.com",
            projectId: "authapp-386ee",
            storageBucket: "authapp-386ee.appspot.com",
            messagingSenderId: "809698525310",
            appId: "1:809698525310:web:5cb7de80bde9ed1f26982f"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        const tournamentId = urlParams.get('id');
        let tournamentDetails = null;
        let registrationInProgress = false;
        let currentUserBalance = 0;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('regContainer').style.display = 'block';
            if (!tournamentId) {
                showRegStatus('Error: Tournament ID is missing from URL.', 'error');
                document.getElementById('loadingDetails').style.display = 'none';
                return;
            }
            auth.onAuthStateChanged(user => {
                if (user) {
                    loadRegistrationData();
                } else {
                    window.location.href = 'login.html';
                }
            });
        });

        // =================================================================
        // DATA FETCHING & DISPLAY LOGIC
        // =================================================================
        async function fetchUserBalance() {
            if (!auth.currentUser) return 0;
            const userId = auth.currentUser.uid;
            
            try {
                const walletRef = db.collection('wallets').doc(userId);
                const walletDoc = await walletRef.get();
                let secureBalance = (walletDoc.exists) ? walletDoc.data().balance : undefined;

                if (typeof secureBalance !== 'undefined') {
                    return secureBalance;
                }

                const [dSnap, wSnap] = await Promise.all([
                    db.collection('deposits').where('userId', '==', userId).where('status', '==', 'approved').get(),
                    db.collection('withdrawals').where('userId', '==', userId).where('status', '==', 'approved').get()
                ]);
                let deposits = 0; dSnap.forEach(doc => deposits += (parseFloat(doc.data().amount) || 0));
                let withdrawals = 0; wSnap.forEach(doc => withdrawals += (parseFloat(doc.data().amount) || 0));
                const calculatedBalance = deposits - withdrawals;

                await walletRef.set({ balance: calculatedBalance, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                return calculatedBalance;
            } catch (error) {
                console.error("Error fetching balance:", error);
                showRegStatus('Could not retrieve wallet balance.', 'error');
                return 0;
            }
        }

        async function loadRegistrationData() {
            const loadingEl = document.getElementById('loadingDetails');
            const contentEl = document.getElementById('detailsContent');
            try {
                const doc = await db.collection('tournaments').doc(tournamentId).get();
                if (!doc.exists) {
                    showRegStatus('Tournament not found.', 'error'); return;
                }
                tournamentDetails = { id: doc.id, ...doc.data() };
                currentUserBalance = await fetchUserBalance();
                displayTournamentDetails();
                await checkRegistrationStatus();
            } catch (error) {
                console.error('Error loading registration data:', error);
                showRegStatus('Failed to load tournament data.', 'error');
            } finally {
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            }
        }

        function displayTournamentDetails() {
            if (!tournamentDetails) return;
            document.getElementById('tourneyTitle').textContent = tournamentDetails.title || 'Untitled';
            document.getElementById('tourneyGame').textContent = tournamentDetails.game || 'Esports';
            document.getElementById('entryFeeDisplay').textContent = `₹${formatCurrency(tournamentDetails.entryFee || 0)}`;
            document.getElementById('prizePoolDisplay').textContent = `₹${formatCurrency(tournamentDetails.prizePool || 0)}`;
            document.getElementById('startDateDisplay').textContent = formatDate(tournamentDetails.startDate);
            document.getElementById('currentBalanceDisplay').textContent = `₹${formatCurrency(currentUserBalance || 0)}`;
            checkBalanceAndToggleRegistration();
        }

        function checkBalanceAndToggleRegistration() {
            const registerBtn = document.getElementById('registerBtn');
            const isRegistered = registerBtn.textContent.includes('Registered');
            if (isRegistered) return; 

            const entryFee = tournamentDetails.entryFee || 0;
            if (currentUserBalance < entryFee) {
                registerBtn.disabled = true;
                registerBtn.textContent = 'Insufficient Balance';
                showRegStatus(`Your balance is too low. Required: ₹${formatCurrency(entryFee)}.`, 'error');
            } else if (!['registering', 'upcoming'].includes(tournamentDetails.status)) {
                registerBtn.disabled = true;
                registerBtn.textContent = `Registration Closed (${tournamentDetails.status})`;
            } else {
                registerBtn.disabled = false;
                registerBtn.textContent = `Register and Pay ₹${formatCurrency(entryFee)}`;
            }
        }

        async function checkRegistrationStatus() {
            const participantDoc = await db.collection('tournaments').doc(tournamentId).collection('participants').doc(auth.currentUser.uid).get();
            if (participantDoc.exists) {
                const registerBtn = document.getElementById('registerBtn');
                registerBtn.disabled = true;
                registerBtn.textContent = 'Already Registered ✅';
                showRegStatus('You are already registered!', 'success');
            }
        }

        // =================================================================
        // REGISTRATION TRANSACTION
        // =================================================================
        async function handleRegistration() {
            if (registrationInProgress) return;
            registrationInProgress = true;

            const registerBtn = document.getElementById('registerBtn');
            const originalText = registerBtn.textContent;
            registerBtn.disabled = true;
            registerBtn.innerHTML = `Processing... <span class="loading-spinner"></span>`;
            
            const entryFee = tournamentDetails.entryFee || 0;
            const freshBalance = await fetchUserBalance();
            currentUserBalance = freshBalance;

            if (freshBalance < entryFee) {
                showRegStatus('Registration Failed: Insufficient balance.', 'error');
                registrationInProgress = false;
                checkBalanceAndToggleRegistration();
                return;
            }

            try {
                await db.runTransaction(async (transaction) => {
                    const userId = auth.currentUser.uid;
                    const walletRef = db.collection('wallets').doc(userId);
                    const participantRef = db.collection('tournaments').doc(tournamentId).collection('participants').doc(userId);
                    const tournamentRef = db.collection('tournaments').doc(tournamentId);
                    const userTournamentsRef = db.collection('userTournaments').doc(userId);

                    // --- FIX: Correct way to read multiple documents in a transaction ---
                    const [walletDoc, participantDoc] = await Promise.all([
                        transaction.get(walletRef),
                        transaction.get(participantRef)
                    ]);
                    // --------------------------------------------------------------------

                    if (!walletDoc.exists || walletDoc.data().balance < entryFee) {
                        throw new Error('Insufficient wallet balance during transaction.');
                    }
                    if (participantDoc.exists) {
                        throw new Error('Already registered.');
                    }

                    // Perform all 4 critical writes atomically
                    transaction.update(walletRef, { balance: firebase.firestore.FieldValue.increment(-entryFee) });
                    transaction.update(tournamentRef, { currentPlayers: firebase.firestore.FieldValue.increment(1) });
                    transaction.set(participantRef, { userId, email: auth.currentUser.email, registeredAt: firebase.firestore.FieldValue.serverTimestamp() });
                    transaction.set(userTournamentsRef, { tournamentIds: firebase.firestore.FieldValue.arrayUnion(tournamentId) }, { merge: true });
                });

                showRegStatus('Registration successful!', 'success');
                registerBtn.textContent = 'Successfully Registered ✅';
                registerBtn.disabled = true;
                currentUserBalance = freshBalance - entryFee; 
                displayTournamentDetails();

            } catch (error) {
                console.error('Critical Registration Error:', error);
                showRegStatus(error.message || 'Registration failed due to a server error.', 'error');
                registerBtn.textContent = originalText;
                checkBalanceAndToggleRegistration();
            } finally {
                registrationInProgress = false;
            }
        }

        // =================================================================
        // UTILITY FUNCTIONS
        // =================================================================
        function showRegStatus(message, type = 'info') {
            const statusEl = document.getElementById('regStatus');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', { minimumFractionDigits: 0 }).format(amount);
        }

        function formatDate(timestamp) {
            if (!timestamp?.toDate) return 'TBD';
            return timestamp.toDate().toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>